<!doctype html>
<meta charset="utf8">
<link rel="help" href="https://w3c.github.io/payment-request/#dfn-abort-the-update">
<title>
</title>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script>
setup({ explicit_done: true, explicit_timeout: true });
const methods = [{ supportedMethods: ["basic-card"] }];

const details = {
  total: {
    label: "Total due",
    amount: { currency: "USD", value: "1.0" },
  },
};

const options = {
  requestShipping: true,
};
const negativeAmount = {
  currency: "USD",
  value: "-1.00",
};

const validAmount = {
  currency: "USD",
  value: "1.00",
};

const invalidAmount = {
  currency: "Â¡INVALID!",
  value: "1.00",
};

const invalidTotal = {
  total: {
    label: "Invalid total",
    amount: invalidAmount,
  },
};

const validTotal = {
  total: {
    label: "Valid total",
    amount: invalidAmount,
  },
};

const negativeTotal = {
  total: {
    label: "Invalid total",
    amount: negativeAmount,
  },
};

const validDisplayItem = {
  amount: validAmount,
  label: "Valid display item",
};

const invalidDisplayItem = {
  amount: invalidAmount,
  label: "invalid currency",
};

const invalidDisplayItems = {
  displayItems: [invalidDisplayItem, validDisplayItem],
};

const invalidShippingOption = {
  id: "abc",
  label: "invalid shipping option",
  amount: invalidAmount,
  selected: true,
};

const validShippingOption = {
  id: "abc",
  label: "valid shipping option",
  amount: validAmount,
};

const invalidShippingOptions = {
  shippingOptions: [invalidShippingOption, validShippingOption],
};

// Modifiers apply when the user chooses to pay with
// a credit card.
const modifierWithInvalidDisplayItems = {
  modifiers: [
    {
      additionalDisplayItems: [invalidDisplayItem, validDisplayItem],
      supportedMethods: "basic-card",
      total: {
        label: "total",
        amount: validAmount,
      },
    },
  ],
};

const modifierWithInvalidTotal = {
  modifiers: [
    {
      additionalDisplayItems: [validDisplayItem],
      supportedMethods: "basic-card",
      total: {
        label: "total",
        amount: invalidAmount,
      },
    },
  ],
};

const recursiveData = {};
recursiveData.foo = recursiveData;

const modifierWithRecursiveData = {
  modifiers: [
    {
      supportedMethods: "basic-card",
      total: {
        label: "total",
        amount: invalidAmount,
      },
      data: recursiveData,
    },
  ],
};

function testBadUpdate(button, badDetails, expectedError, errorCode) {
  promise_test(async t => {
    const request = new PaymentRequest(methods, details, options);
    request.onshippingaddresschange = event => {
      event.updateWith(badDetails);
    };
    // First we check the bad update.
    const acceptPromise = request.show();
    await promise_rejects(
      t,
      expectedError,
      acceptPromise,
      "badDetails must cause acceptPromise to reject with expectedError"
    );
    // The request [[state]] is now "closed", so check for Invalid state
    await promise_rejects(
      t,
      "InvalidStateError",
      request.show(),
      "show() must reject with InvalidStateError"
    );
  }, button.innerText.trim());
}


</script>
<h2>updateWith() method - "abort the update"</h2>
<p>
  When the payment sheet is shown, change the shipping address.
</p>
<ol>
  <li>
    <button onclick="
      const rejectedPromise = Promise.reject(new SyntaxError('test')).catch(err => err);
      testBadUpdate(this, rejectedPromise, 'AbortError');
    ">
      Rejection of detailsPromise must abort the update with an "AbortError" DOMException.
    </button>
  </li>
  <li>
    <button onclick="
      const invalidDetails = { total: `this will cause a TypeError!` };
      testBadUpdate(this, invalidDetails, new TypeError());
    ">
      Total in the update is a string, so converting to IDL must abort the update with a TypeError.
    </button>
  </li>
  <li>
    <button onclick="
      const invalidDetails = { total: recursiveData };
      testBadUpdate(this, invalidDetails, new TypeError());
    ">
      Total is recursive, so converting to IDL must abort the update with a TypeError.
    </button>
  </li>
  <li>
    <button onclick="
      const badDetails = Object.assign({}, details,  negativeTotal);
      testBadUpdate(this, badDetails, new TypeError());
    ">
      Updating with a negative total results in a TypeError.
    </button>
  </li>
  <li>
    <button onclick="
      const badDetails = Object.assign({}, details, invalidDisplayItems);
      testBadUpdate(this, badDetails, new RangeError());
    ">
      Updating with a displayItem with an invalid currency results in TypeError.
    </button>
  </li>
  <li>
    <button onclick="
      const duplicateShippingOptions = [validShippingOption, validShippingOption];
      const badDetails = Object.assign({}, details, duplicateShippingOptions);
      testBadUpdate(this, badDetails, new TypeError());
    ">
      Updating with duplicate shippingOptions (same IDs) results in a TypeError.
    </button>
  </li>
  <li>
    <button onclick="
      const badDetails = Object.assign({}, details, invalidShippingOptions);
      testBadUpdate(this, badDetails, new RangeError());
    ">
      Updating with a shippingOption with an invalid currency value results in a RangError.
    </button>
  </li>
  <li>
    <button onclick="
      const badDetails = Object.assign({}, details, modifierWithInvalidTotal);
      testBadUpdate(this, badDetails, new RangeError());
    ">
      Must throw a RangeError when a modifier's total item has an invalid currency.
    </button>
  </li>
 <li>
   <button onclick="
    const badDetails = Object.assign({}, details, modifierWithInvalidDisplayItems);
    testBadUpdate(this, badDetails, new RangeError());
  ">
      Must throw a RangeError when a modifier display item has an invalid currency.
   </button>
  </li>
 <li>
    <button onclick="
      const badDetails = Object.assign({}, details, modifierWithRecursiveData);
      testBadUpdate(this, badDetails, new TypeError());
    ">
      Must throw as Modifier has a recursive dictionary.
    </button>
  </li>
  <li>
    <button onclick="done();">Done!</button>
  </li>
</ol>
